<div
*ngIf="role?.toUpperCase() === 'ADMIN' || role?.toUpperCase() === 'MANAGER'"
 class="flex justify-end mt-2">
  <button (click)="openCreateTaskModal()" class="flex items-center ml-3 gap-2 px-4 py-2 text-sm font-semibold bg-sky-600 text-white rounded-lg hover:bg-sky-500 transform hover:-translate-y-0.5 transition-all duration-200 shadow-md hover:shadow-sky-500/30">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
    Create New Task
  </button>
</div>

<div
        *ngIf="isCreateTaskModalOpen"
        class="fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-300 ease-out"
        [ngClass]="{
          'opacity-100': isCreateTaskModalOpen,
          'opacity-0': !isCreateTaskModalOpen
        }"
      >
        <div
          (click)="closeCreateTaskModal()"
          class="absolute inset-0 bg-slate-900/80 backdrop-blur-[0px]"
        ></div>

        <div
          class="relative bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-lg p-6 mx-4 transition-all transform duration-300 ease-out"
          [ngClass]="{
            'scale-100 opacity-100': isCreateTaskModalOpen,
            'scale-95 opacity-0': !isCreateTaskModalOpen
          }"
        >
          <div class="flex items-center justify-between pb-4 mb-4 border-b border-slate-700">
            <h2 class="text-xl font-bold text-neutral-100">Create a New Task</h2>
            <button
              type="button"
              (click)="closeCreateTaskModal()"
              class="p-2 -mr-2 rounded-full text-neutral-400 hover:bg-slate-700 hover:text-white transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>

          <form (ngSubmit)="submitCreateTask()" #taskForm="ngForm" class="space-y-5">
            <div>
              <label class="block mb-1.5 text-sm font-medium text-neutral-300">Title</label>
              <input type="text" [(ngModel)]="newTask.title" name="title" class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 placeholder:text-neutral-500 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200" required />
            </div>
      
            <div>
              <label class="block mb-1.5 text-sm font-medium text-neutral-300">Description</label>
              <textarea [(ngModel)]="newTask.description" name="description" rows="3" class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 placeholder:text-neutral-500 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200"></textarea>
            </div>
      
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block mb-1.5 text-sm font-medium text-neutral-300">Assignee</label>
                <select [(ngModel)]="newTask.assignee.user_id" name="assignee" class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200" required>
                  <option [ngValue]="null" disabled>Select an employee</option>
                  <option *ngFor="let emp of employees" [ngValue]="emp.user_id">{{ emp.username || emp.email }}</option>
                </select>
              </div>
              <div>
                <label class="block mb-1.5 text-sm font-medium text-neutral-300">Priority</label>
                <select [(ngModel)]="newTask.priority" name="priority" class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200">
                  <option value="LOW">Low</option>
                  <option value="MEDIUM">Medium</option>
                  <option value="HIGH">High</option>
                </select>
              </div>
            </div>
             <div>
                <label class="block mb-1.5 text-sm font-medium text-neutral-300">Type</label>
                <select [(ngModel)]="newTask.type" name="type" class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200">
                  <option value="BUG">Bug</option>
                  <option value="FEATURE">Feature</option>
                  <option value="REFACTOR">Refactor</option>
                  <option value="TESTING">Testing</option>
                </select>
              </div>
      
            <div class="flex justify-end space-x-3 pt-4">
              <button type="button" (click)="closeCreateTaskModal()" class="px-5 py-2.5 bg-transparent border border-neutral-600 text-neutral-300 hover:bg-neutral-700 hover:text-white font-semibold rounded-lg transition-colors duration-200">Cancel</button>
              <button type="submit" [disabled]="taskForm.invalid" class="px-5 py-2.5 bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-semibold rounded-lg shadow-md hover:shadow-lg hover:shadow-sky-500/30 transform hover:-translate-y-0.5 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Create Task</button>
            </div>
          </form>
        </div>
      </div>

<div class="w-full relative overflow-hidden">
  <div *ngIf="isLoading"
     class="absolute inset-0 flex items-start justify-center
            bg-gradient-to-br from-sky-950  to-lightblue-700
            bg-opacity-70 z-10 pt-10">
  <div class="w-16 h-16 border-7 border-gray-600 border-t-blue-700 rounded-full animate-spin"></div>
</div>

  <div class="flex justify-evenly gap-6 px-4 py-5">
    <ng-container *ngFor="let status of taskStatus; let i = index">
      <div
        class="flex-1 min-w-0 h-[600px] rounded-xl p-4 transition-transform duration-300 cursor-pointer"
        [ngClass]="getColumnGradient(i)"
        (dragover)="onDragOver($event, status, null)"
        (drop)="onDrop($event, status)"
      >
<h3 class="mb-2 flex items-center justify-between text-sm font-semibold text-white">
  <span class="tracking-widest">{{ status }}</span>
  <ng-container [ngSwitch]="status">
    <span *ngSwitchCase="'DONE'" class="inline-flex items-center text-white">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
        <path fill-rule="evenodd" d="M10.28 15.72a.75.75 0 0 1-1.06 0l-3-3a.75.75 0 1 1 1.06-1.06l2.47 2.47 5.97-5.97a.75.75 0 1 1 1.06 1.06l-6.5 6.5z" clip-rule="evenodd"/>
      </svg>
    </span>
    <span *ngSwitchDefault class="text-white">{{ getTasksByStatus(status).length }}</span>
  </ng-container>
</h3>
<div [ngClass]="getGlowBarClass(i)" class="h-[3px] w-full rounded-full mb-4 transition-all duration-300"></div>
<div class="flex flex-col gap-3 h-[560px] overflow-y-scroll overflow-x-hidden hide-scrollbar">

          <ng-container *ngFor="let task of getTasksByStatus(status)">
            <div *ngIf="dragOverStatus === status && dragOverTaskId === task.id && dragOverPosition === 'before'"
                 class="h-1 bg-white/60 rounded transition-all duration-150"></div>
            <div
              class="flex justify-between items-start p-3 rounded-lg bg-zinc-800/80 shadow-md cursor-move
                     transition-transform duration-200 hover:scale-95 border border-transparent"
              draggable="true"
              (dragstart)="onDragStart($event, task)"
              (dragend)="onDragEnd($event)"
              (dragover)="onDragOver($event, status, task.id)"
              (click)="openModal(task)"
              [ngClass]="{
                'ring-2 ring-emerald-400/40': status==='DONE' && recentlyCompleted.has(task.id),
                'ring-2 ring-yellow-400/40': status==='IN PROGRESS' && recentlyCompleted.has(task.id),
                'ring-2 ring-purple-400/30': status==='IN REVIEW' && recentlyCompleted.has(task.id),
                'ring-2 ring-blue-400/30': status==='TO DO' && recentlyCompleted.has(task.id)
              }"
            >
            <span
                  class="absolute bottom-1 right-1 w-3 h-3 rounded-full z-[9999]"
                  [ngClass]="{
                    'bg-red-500': task.priority === 'HIGH',
                    'bg-yellow-400': task.priority === 'MEDIUM',
                    'bg-green-500': task.priority === 'LOW'
                  }"
              ></span>
              <div class="flex flex-col gap-1">
                <h4 class="text-sm font-semibold text-white">{{ task.title }}</h4>
                <p class="text-xs text-gray-300 line-clamp-2">{{ task.description }}</p>
                <p class="text-xs text-gray-400">#{{ task.id }}</p>
              </div>
              <p class="text-xs text-white font-medium">{{ task.assignee.username }}</p>
            </div>
            <div *ngIf="dragOverStatus === status && dragOverTaskId === task.id && dragOverPosition === 'after'"
                 class="h-1 bg-white/60 rounded transition-all duration-150"></div>
          </ng-container>
          <div *ngIf="dragOverStatus === status && dragOverTaskId === null"
               class="h-1 bg-white/60 rounded transition-all duration-150"></div>
        </div>
    
      </div>
     
    </ng-container>
  </div>
</div>


<ng-container *ngIf="showModal && selectedTask">
  <div
    class="fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-300 ease-out"
    [ngClass]="{
      'opacity-100': showModal,
      'opacity-0': !showModal
    }"
  >
    <!-- Overlay -->
    <div
      (click)="closeModal()"
      class="absolute inset-0 bg-slate-900/80 backdrop-blur-[0px]"
    ></div>

    <!-- Modal Box -->
    <div
      class="relative bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-lg p-6 mx-4 transition-all transform duration-300 ease-out"
      [ngClass]="{
        'scale-100 opacity-100': showModal,
        'scale-95 opacity-0': !showModal
      }"
      (click)="$event.stopPropagation()"
    >
      <!-- Header -->
      <div class="flex items-center justify-between pb-4 mb-4 border-b border-slate-700">
        <h2 class="text-xl font-bold text-neutral-100 text-center w-full">
          <ng-container *ngIf="isManagerOrAdmin; else viewTitle">
            <input
              [(ngModel)]="selectedTask.title"
              class="w-full text-center bg-transparent border-none text-xl font-bold text-white focus:outline-none"
              placeholder="Task Title"
            />
          </ng-container>
          <ng-template #viewTitle>{{ selectedTask.title }}</ng-template>
        </h2>
        <button
          type="button"
          (click)="closeModal()"
          class="absolute right-4 top-4 p-2 rounded-full text-neutral-400 hover:bg-slate-700 hover:text-white transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Body -->
      <div class="space-y-5">
        <!-- Description -->
        <div>
          <label class="block mb-1.5 text-sm font-medium text-neutral-300">Description</label>
          <ng-container *ngIf="isManagerOrAdmin; else viewDesc">
            <textarea
              [(ngModel)]="selectedTask.description"
              rows="3"
              class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 text-white placeholder:text-neutral-500 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200"
            ></textarea>
          </ng-container>
          <ng-template #viewDesc>
            <p class="text-gray-300">{{ selectedTask.description }}</p>
          </ng-template>
        </div>

        <!-- Assignee -->
        <div>
          <label class="block mb-1.5 text-sm font-medium text-neutral-300">Assignee</label>
          <ng-container *ngIf="isManagerOrAdmin; else viewAssignee">
            <input disabled
              [(ngModel)]="selectedTask.assignee.username"
              class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 text-white focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200"
            />
          </ng-container>
          <ng-template #viewAssignee>
            <p class="text-gray-300">{{ selectedTask.assignee.username }}</p>
          </ng-template>
        </div>

        <!-- Status -->
        <div>
          <label class="block mb-1.5 text-sm font-medium text-neutral-300">Status</label>
          <ng-container *ngIf="isManagerOrAdmin; else viewStatus">
            <select
              [(ngModel)]="selectedTask.status"
              class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 text-white focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200"
            >
              <ng-container *ngFor="let s of taskStatus">
                <option [value]="s">{{ s }}</option>
              </ng-container>
            </select>
          </ng-container>
          <ng-template #viewStatus>
            <p class="text-gray-300">{{ selectedTask.status }}</p>
          </ng-template>
        </div>

        <!-- Comments (Disabled Placeholder) -->
        <div>
          <label class="block mb-1.5 text-sm font-medium text-neutral-300">Comments</label>
          <textarea
            class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 text-gray-400 cursor-not-allowed"
            rows="3"
            placeholder="Comments (coming soon)"
            disabled
          ></textarea>
        </div>
      </div>

      <!-- Footer Buttons -->
      <div class="flex justify-end space-x-3 pt-6">
        <button
          type="button"
          (click)="closeModal()"
          class="px-5 py-2.5 bg-transparent border border-neutral-600 text-neutral-300 hover:bg-neutral-700 hover:text-white font-semibold rounded-lg transition-colors duration-200"
        >
          Close
        </button>
        <button
          *ngIf="isManagerOrAdmin"
          (click)="saveTask()"
          class="px-5 py-2.5 bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-semibold rounded-lg shadow-md hover:shadow-lg hover:shadow-sky-500/30 transform hover:-translate-y-0.5 transition-all duration-200"
        >
          Save
        </button>
      </div>
    </div>
  </div>
  
</ng-container>
