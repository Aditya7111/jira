<app-navbar></app-navbar>

<div class="overflow-x-auto mt-4">
  <div class="flex w-max min-w-full mx-auto gap-4">
    @for (status of taskStatus; track $index) {

    <div
      class="relative bg-zinc-900 flex-none w-70 rounded-md p-3 transition-colors duration-300"
      (dragover)="onDragOver($event, status, null)"
      (drop)="onDrop($event, status)"
    >
      <h3 class="mb-4 text-neutral-300 flex items-center justify-between">
        <span class="text-xs font-semibold tracking-widest text-neutral-400">{{ status }}</span>
        <ng-container [ngSwitch]="status">
          <span *ngSwitchCase="'DONE'" class="inline-flex items-center text-emerald-500">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              viewBox="0 0 24 24"
              fill="currentColor"
              aria-hidden="true"
            >
              <path
                fill-rule="evenodd"
                d="M10.28 15.72a.75.75 0 0 1-1.06 0l-3-3a.75.75 0 1 1 1.06-1.06l2.47 2.47 5.97-5.97a.75.75 0 1 1 1.06 1.06l-6.5 6.5z"
                clip-rule="evenodd"
              />
            </svg>
            <span class="sr-only">{{ getTasksByStatus(status).length }} done</span>
          </span>
          <span *ngSwitchDefault class="text-neutral-400">
            {{ getTasksByStatus(status).length }}
          </span>
        </ng-container>
      </h3>

      <div>
        @for (task of getTasksByStatus(status); track task.id) {

        <div
          *ngIf="
            dragOverStatus === status && dragOverTaskId === task.id && dragOverPosition === 'before'
          "
          class="h-0.5 bg-blue-500 rounded my-1 transition-all duration-150"
        ></div>

        <div
          class="flex items-end justify-between px-2 py-1 bg-zinc-800 rounded-sm my-1 shadow-md cursor-move"
          draggable="true"
          (dragstart)="onDragStart($event, task)"
          (dragend)="onDragEnd($event)"
          (dragover)="onDragOver($event, status, task.id)"
          (click)="openModal(task)"
          [class.done-splash1]="status === 'DONE' && recentlyCompleted.has(task.id)"
          [class.done-splash2]="status === 'IN REVIEW' && recentlyCompleted.has(task.id)"
          [class.done-splash3]="status === 'IN PROGRESS' && recentlyCompleted.has(task.id)"
          [class.done-splash4]="status === 'TO DO' && recentlyCompleted.has(task.id)"

        >
          <div class="flex flex-col gap-2">
            <h4>{{ task.title }}</h4>
            <p>{{ task.description }}</p>
            <p>{{ task.id }}</p>
          </div>
          <p>{{ task.assignee }}</p>
        </div>

        <div
          *ngIf="
            dragOverStatus === status && dragOverTaskId === task.id && dragOverPosition === 'after'
          "
          class="h-0.5 bg-blue-500 rounded my-1 transition-all duration-150"
        ></div>

        }

        <div
          *ngIf="dragOverStatus === status && dragOverTaskId === null"
          class="h-0.5 bg-blue-500 rounded my-1 transition-all duration-150"
        ></div>
      </div>
    </div>

    }
  </div>
</div>

@if (showModal && selectedTask) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header" [ngClass]="getStatusClass(selectedTask.status)">
        <input
          *ngIf="isManagerOrAdmin"
          [(ngModel)]="selectedTask.title"
          class="modal-title"
          placeholder="Task Title"
        />
        <h2 *ngIf="!isManagerOrAdmin" class="modal-title">{{ selectedTask.title }}</h2>
      </div>
      <div class="modal-body">
        <div class="field-group">
          <label><strong>Description:</strong></label>
          <textarea
            *ngIf="isManagerOrAdmin"
            [(ngModel)]="selectedTask.description"
            class="modal-input"
            placeholder="Task Description"
            rows="1"
          ></textarea>
          <p *ngIf="!isManagerOrAdmin">{{ selectedTask.description }}</p>
        </div>
        <div class="field-group">
          <label><strong>Assignee:</strong></label>
          <input
            *ngIf="isManagerOrAdmin"
            [(ngModel)]="selectedTask.assignee"
            class="modal-input"
            placeholder="Assignee"
          />
          <p *ngIf="!isManagerOrAdmin">{{ selectedTask.assignee }}</p>
        </div>
        <div class="field-group">
          <label><strong>Status:</strong></label>
          <select
            *ngIf="isManagerOrAdmin"
            [(ngModel)]="selectedTask.status"
            class="modal-input"
          >
            @for (status of taskStatus; track status) {
              <option [value]="status">{{ status }}</option>
            }
          </select>
          <p *ngIf="!isManagerOrAdmin">{{ selectedTask.status }}</p>
        </div>
        <div class="field-group comment-section">
          <label><strong>Comments:</strong></label>
          <textarea
            class="modal-input"
            placeholder="Comment functionality to be implemented later"
            disabled
            rows="4"
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button *ngIf="isManagerOrAdmin" class="save-button" (click)="saveTask()">Save</button>
        <button class="close-button" (click)="closeModal()">Close</button>
      </div>
    </div>
  </div>
}