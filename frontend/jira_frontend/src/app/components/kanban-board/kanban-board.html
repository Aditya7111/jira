<div class="flex justify-end px-4 py-2">
  <div *ngIf="role?.toUpperCase() === 'ADMIN' || role?.toUpperCase() === 'MANAGER'" class="inline-block">
    <button
      (click)="openCreateTaskModal()"
      class="flex items-center gap-2 px-4 py-2 text-sm font-semibold bg-sky-600 text-white rounded-lg hover:bg-sky-500 transform hover:-translate-y-0.5 transition-all duration-200 shadow-md hover:shadow-sky-500/30"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Create New Task
    </button>
  </div>
</div>



<div
  *ngIf="isCreateTaskModalOpen"
  class="fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-300 ease-out"
  [ngClass]="{
    'opacity-100': isCreateTaskModalOpen,
    'opacity-0': !isCreateTaskModalOpen
  }"
  >
  <div
    (click)="closeCreateTaskModal()"
    class="absolute inset-0 bg-slate-900/80 backdrop-blur-[0px]"
  ></div>

  <div
    class="relative bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-lg p-6 mx-4 transition-all transform duration-300 ease-out"
    [ngClass]="{
      'scale-100 opacity-100': isCreateTaskModalOpen,
      'scale-95 opacity-0': !isCreateTaskModalOpen
    }"
  >
    <div class="flex items-center justify-between pb-4 mb-4 border-b border-slate-700">
      <h2 class="text-xl font-bold text-neutral-100">Create a New Task</h2>
      <button
        type="button"
        (click)="closeCreateTaskModal()"
        class="p-2 -mr-2 rounded-full text-neutral-400 hover:bg-slate-700 hover:text-white transition-colors"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <form (ngSubmit)="submitCreateTask()" #taskForm="ngForm" class="space-y-5">
      <div>
        <label class="block mb-1.5 text-sm font-medium text-neutral-300">Title</label>
        <input type="text" [(ngModel)]="newTask.title" name="title" class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 placeholder:text-neutral-500 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200" required />
      </div>
  
      <div>
        <label class="block mb-1.5 text-sm font-medium text-neutral-300">Description</label>
        <textarea [(ngModel)]="newTask.description" name="description" rows="3" class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 placeholder:text-neutral-500 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200"></textarea>
      </div>
  
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block mb-1.5 text-sm font-medium text-neutral-300">Assignee</label>
          <select [(ngModel)]="newTask.assignee.user_id" name="assignee" class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200" required>
            <option [ngValue]="null" disabled>Select an employee</option>
            <option *ngFor="let emp of employees" [ngValue]="emp.user_id">{{ emp.username || emp.email }}</option>
          </select>
        </div>
        <div>
          <label class="block mb-1.5 text-sm font-medium text-neutral-300">Priority</label>
          <select [(ngModel)]="newTask.priority" name="priority" class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200">
            <option value="LOW">Low</option>
            <option value="MEDIUM">Medium</option>
            <option value="HIGH">High</option>
          </select>
        </div>
      </div>
       <div>
          <label class="block mb-1.5 text-sm font-medium text-neutral-300">Type</label>
          <select [(ngModel)]="newTask.type" name="type" class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200">
            <option value="BUG">Bug</option>
            <option value="FEATURE">Feature</option>
            <option value="REFACTOR">Refactor</option>
            <option value="TESTING">Testing</option>
          </select>
        </div>
  
      <div class="flex justify-end space-x-3 pt-4">
        <button type="button" (click)="closeCreateTaskModal()" class="px-5 py-2.5 bg-transparent border border-neutral-600 text-neutral-300 hover:bg-neutral-700 hover:text-white font-semibold rounded-lg transition-colors duration-200">Cancel</button>
        <button type="submit" [disabled]="taskForm.invalid" class="px-5 py-2.5 bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-semibold rounded-lg shadow-md hover:shadow-lg hover:shadow-sky-500/30 transform hover:-translate-y-0.5 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Create Task</button>
      </div>
    </form>
  </div>
</div>

<div class="w-full overflow-hidden">
  <div class="flex justify-evenly gap-6 px-4 py-5">
    <ng-container *ngFor="let status of taskStatus; let i = index">
      <div
        class="flex-1 min-w-0 h-[600px] rounded-xl p-4 transition-transform duration-300 cursor-pointer"
        [ngClass]="getColumnGradient(i)"
        (dragover)="onDragOver($event, status, null)"
        (drop)="onDrop($event, status)"
      >
<h3 class="mb-2 flex items-center justify-between text-sm font-semibold text-white">
  <span class="tracking-widest">{{ status }}</span>
  <ng-container [ngSwitch]="status">
    <span *ngSwitchCase="'DONE'" class="inline-flex items-center text-white">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
        <path fill-rule="evenodd" d="M10.28 15.72a.75.75 0 0 1-1.06 0l-3-3a.75.75 0 1 1 1.06-1.06l2.47 2.47 5.97-5.97a.75.75 0 1 1 1.06 1.06l-6.5 6.5z" clip-rule="evenodd"/>
      </svg>
    </span>
    <span *ngSwitchDefault class="text-white">{{ getTasksByStatus(status).length }}</span>
  </ng-container>
</h3>
<div [ngClass]="getGlowBarClass(i)" class="h-[3px] w-full rounded-full mb-4 transition-all duration-300"></div>
<div class="flex flex-col gap-3 h-[560px] overflow-y-scroll overflow-x-hidden hide-scrollbar">

      <ng-container *ngFor="let task of getTasksByStatus(status)">
        <div *ngIf="dragOverStatus === status && dragOverTaskId === task.id && dragOverPosition === 'before'"
             class="h-1 bg-white/60 rounded transition-all duration-150"></div>

        <div
          class="relative group p-4 pl-6 rounded-xl bg-gradient-to-b from-zinc-900/80 to-zinc-800/70 shadow-md cursor-grab transition-all duration-200 hover:-translate-y-0.5 hover:shadow-2xl overflow-hidden"
          draggable="true"
          (dragstart)="onDragStart($event, task)"
          (dragend)="onDragEnd($event)"
          (dragover)="onDragOver($event, status, task.id)"
          (click)="openModal(task)"
          [ngClass]="{
            'ring-2 ring-emerald-400/40': status==='DONE' && recentlyCompleted.has(task.id),
            'ring-2 ring-yellow-400/40': status==='IN_PROGRESS' && recentlyCompleted.has(task.id),
            'ring-2 ring-purple-400/30': status==='IN_REVIEW' && recentlyCompleted.has(task.id),
            'ring-2 ring-blue-400/30': status==='TO_DO' && recentlyCompleted.has(task.id)
          }"
        >

<div class="absolute left-0 top-0 bottom-0 w-1 rounded-l-xl"
[ngClass]="{
  'bg-emerald-500': task.priority === 'LOW',
  'bg-amber-400': task.priority === 'MEDIUM',
  'bg-rose-500': task.priority === 'HIGH'
}"></div>

          <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"
               [ngClass]="{
                 'bg-gradient-to-r from-blue-500/4 to-transparent': status === 'TO_DO',
                 'bg-gradient-to-r from-sky-400/4 to-transparent': status === 'IN_PROGRESS',
                 'bg-gradient-to-r from-purple-400/4 to-transparent': status === 'IN_REVIEW',
                 'bg-gradient-to-r from-emerald-400/4 to-transparent': status === 'DONE'
               }"></div>

          <div class="relative z-10 flex flex-col gap-2 min-h-[64px]">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 min-w-0">
                <h4 class="text-sm font-semibold text-white truncate">{{ task.title }}</h4>
                <p class="text-xs text-neutral-300 line-clamp-2 leading-snug mt-1">{{ task.description }}</p>
              </div>
              
              <span
  class="ml-3 px-3 py-1 text-[11px] rounded-full font-semibold uppercase tracking-wide self-start shadow-sm backdrop-blur-sm flex flex-col items-center justify-center text-center"
  [ngClass]="{
    'bg-emerald-500/15 text-emerald-300 border border-emerald-400/20': task.priority === 'LOW',
    'bg-amber-400/20 text-amber-300 border border-amber-500/30': task.priority === 'MEDIUM',
    'bg-rose-500/20 text-rose-300 border border-rose-500/30': task.priority === 'HIGH'
  }"
>
  <span>{{ task.priority }}</span>
  
</span>


            </div>

            <div class="flex items-center justify-between pt-1">
              <p class="text-xs text-gray-400 font-mono">{{ task.type }}</p>
              <p class="text-xs text-white font-medium italic truncate">{{ task.assignee.username }}</p>
            </div>
          </div>

        </div>

        <div *ngIf="dragOverStatus === status && dragOverTaskId === task.id && dragOverPosition === 'after'"
             class="h-1 bg-white/60 rounded transition-all duration-150"></div>
      </ng-container>

      <div *ngIf="dragOverStatus === status && dragOverTaskId === null"
           class="h-1 bg-white/60 rounded transition-all duration-150"></div>
    </div>
  </div>
</ng-container>
  </div>
</div>


<ng-container *ngIf="showModal && selectedTask">
  <div
    class="fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-300 ease-out"
    [ngClass]="{
      'opacity-100': showModal,
      'opacity-0': !showModal
    }"
  >
    <!-- Overlay -->
    <div
      (click)="closeModal()"
      class="absolute inset-0 bg-slate-900/80 backdrop-blur-[0px]"
    ></div>

    <!-- Modal Box -->
    <div
      class="relative bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-lg p-6 mx-4 transition-all transform duration-300 ease-out"
      [ngClass]="{
        'scale-100 opacity-100': showModal,
        'scale-95 opacity-0': !showModal
      }"
      (click)="$event.stopPropagation()"
    >
      <!-- Header -->
      <div class="flex items-center justify-between pb-4 mb-4 border-b border-slate-700">
        <h2 class="text-xl font-bold text-neutral-100 text-center w-full">
          <ng-container *ngIf="isManagerOrAdmin; else viewTitle">
            <input
              [(ngModel)]="selectedTask.title"
              class="w-full text-center bg-transparent border-none text-xl font-bold text-white focus:outline-none"
              placeholder="Task Title"
            />
          </ng-container>
          <ng-template #viewTitle>{{ selectedTask.title }}</ng-template>
        </h2>
        <button
          type="button"
          (click)="closeModal()"
          class="absolute right-4 top-4 p-2 rounded-full text-neutral-400 hover:bg-slate-700 hover:text-white transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Body -->
      <div class="space-y-5">
        <!-- Description -->
        <div>
          <label class="block mb-1.5 text-sm font-medium text-neutral-300">Description</label>
          <ng-container *ngIf="isManagerOrAdmin; else viewDesc">
            <textarea
              [(ngModel)]="selectedTask.description"
              rows="3"
              class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 text-white placeholder:text-neutral-500 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200"
            ></textarea>
          </ng-container>
          <ng-template #viewDesc>
            <p class="text-gray-300">{{ selectedTask.description }}</p>
          </ng-template>
        </div>

        <!-- Assignee -->
        <div>
          <label class="block mb-1.5 text-sm font-medium text-neutral-300">Assignee</label>
          <ng-container *ngIf="isManagerOrAdmin; else viewAssignee">
            <input disabled
              [(ngModel)]="selectedTask.assignee.username"
              class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 text-white focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200"
            />
          </ng-container>
          <ng-template #viewAssignee>
            <p class="text-gray-300">{{ selectedTask.assignee.username }}</p>
          </ng-template>
        </div>

        <!-- Status -->
        <div>
          <label class="block mb-1.5 text-sm font-medium text-neutral-300">Status</label>
          <ng-container *ngIf="isManagerOrAdmin; else viewStatus">
            <select
              [(ngModel)]="selectedTask.status"
              class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 text-white focus:border-sky-500 focus:ring-2 focus:ring-sky-500/40 outline-none transition-colors duration-200"
            >
              <ng-container *ngFor="let s of taskStatus">
                <option [value]="s">{{ s }}</option>
              </ng-container>
            </select>
          </ng-container>
          <ng-template #viewStatus>
            <p class="text-gray-300">{{ selectedTask.status }}</p>
          </ng-template>
        </div>

        <!-- Comments (Disabled Placeholder) -->
        <div>
          <label class="block mb-1.5 text-sm font-medium text-neutral-300">Comments</label>
          <textarea
            class="w-full px-3 py-2.5 rounded-lg bg-slate-900/50 border border-slate-600 text-gray-400 cursor-not-allowed"
            rows="3"
            placeholder="Comments (coming soon)"
            disabled
          ></textarea>
        </div>
      </div>

      <!-- Footer Buttons -->
      <div class="flex items-center justify-between pt-6">
        <button
          *ngIf="isManagerOrAdmin"
          (click)="deleteTask()"
          type="button"
          class="p-2.5 rounded-lg text-neutral-400 hover:bg-red-500/20 hover:text-red-400 transition-colors duration-200"
          title="Delete Task"
        >
          <svg 
            xmlns="http://www.w3.org/2000/svg" 
            width="24" 
            height="24" 
            viewBox="0 0 24 24" 
            fill="none" 
            stroke="currentColor" 
            stroke-width="2" 
            stroke-linecap="round" 
            stroke-linejoin="round"
          >
            <path d="M3 6h18"></path>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
        </button>
      
        <div class="flex justify-end space-x-3">
          <button
            type="button"
            (click)="closeModal()"
            class="px-5 py-2.5 bg-transparent border border-neutral-600 text-neutral-300 hover:bg-neutral-700 hover:text-white font-semibold rounded-lg transition-colors duration-200"
          >
            Close
          </button>
          <button
            *ngIf="isManagerOrAdmin"
            (click)="saveTask()"
            class="px-5 py-2.5 bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-semibold rounded-lg shadow-md hover:shadow-lg hover:shadow-sky-500/30 transform hover:-translate-y-0.5 transition-all duration-200"
          >
            Save
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-container>
